language: php
dist: xenial
os: linux

env:
  global:
    - SOURCE_FOLDER_PATH="./"
    - TARGET_FOLDER_PATH="./"

before_install:
  - ./.travis/bootstrap.sh
  - ./.travis/scripts/key_decrypt.sh deployment_keys.tar deployment_keys $encrypted_2a5fd2384630_key $encrypted_2a5fd2384630_iv
  - ./.travis/scripts/git_config.sh
  
install:
  - composer self-update && composer --version
  - composer install --prefer-dist


stages:
  - name: "test"
    if: |
      type != pull_request \
      AND tag IS blank
  - name: "code coverage"
    if: |
      type == pull_request
  - name: "release candidate"
    if: |
      type != pull_request \
      AND tag IS present \
      AND tag =~ ^v\d+\.\d+\.\d+-rc\.\d+$
  - name: "release"
    if: |
      type != pull_request \
      AND tag IS present \
      AND tag =~ ^v\d+\.\d+\.\d+$
  - name: "synchronize"
    if: |
      type != pull_request \
      AND tag IS present \
      AND tag =~ ^v?\d+\.\d+\.\d+-nodeploy\.\d+$

jobs:
  include:
    - stage: "test"
      name: 'PHP 5.6'
      php: '5.6'
      script: vendor/bin/phpunit --verbose
    - name: 'PHP 7.0'
      php: '7.0'
      script: vendor/bin/phpunit --verbose
    - name: 'PHP 7.1'
      php: '7.1'
      script: vendor/bin/phpunit --verbose
    - name: 'PHP 7.2'
      php: '7.2'
      script: vendor/bin/phpunit --verbose
    - name: 'PHP 7.3'
      php: '7.3'
      script: vendor/bin/phpunit --verbose
    - stage: "code coverage"
      name: 'Test & Code coverage'
      php: '7.3'
      script: vendor/bin/phpunit --verbose --coverage-clover=coverage.xml
      after_success:
        - bash <(curl -s https://codecov.io/bash)
    - stage: "release candidate"
      name: "Deploy release candidate"
      php: '7.3'
      script: ./.travis/scripts/deploy.sh release-candidate pubnub/php
    - stage: "release"
      name: "Deploy release"
      php: '7.3'
      script: ./.travis/scripts/deploy.sh release pubnub/php
    - stage: "synchronize"
      name: "Not deployable synchronization"
      php: '7.3'
      script: ./.travis/scripts/synchronization.sh pubnub/php